{% extends "patient/base_patient.html" %}

{% block content %}
<h2>Calendrier des rendez-vous</h2>

<div style="margin-bottom: 10px;">
    <button onclick="prevMonth()">← Mois précédent</button>
    <span id="month-year" style="font-weight: bold; margin: 0 10px;"></span>
    <button onclick="nextMonth()">Mois suivant →</button>
</div>

<table>
    <thead>
        <tr>
            <th>Lundi</th>
            <th>Mardi</th>
            <th>Mercredi</th>
            <th>Jeudi</th>
            <th>Vendredi</th>
            <th>Samedi</th>
            <th>Dimanche</th>
        </tr>
    </thead>
    <tbody id="calendar-body"></tbody>
</table>

<style>
    table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }

    th,
    td {
        border: 1px solid #ccc;
        vertical-align: top;
        padding: 5px;
        height: 100px;
    }

    th {
        background-color: #f0f0f0;
    }

    .event {
        padding: 2px 4px;
        margin: 2px 0;
        border-radius: 4px;
        color: white;
        font-size: 12px;
    }

    .confirmé {
        background-color: #3788d8;
    }

    .en-attente {
        background-color: #f0ad4e;
    }

    .other-month {
        color: #aaa;
    }

    /* gris pour les jours hors mois */
    .event:hover {
        opacity: 0.8;
        cursor: pointer;
    }
</style>

<script>
    const events = {{ events| tojson | safe }}; // tes rendez-vous Flask
    let currentDate = new Date();

    // Noms des mois
    const monthNames = [
        "Janvier", "Février", "Mars", "Avril", "Mai", "Juin",
        "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"
    ];

    // Construire le calendrier
    function buildCalendar() {
        document.getElementById('month-year').textContent = monthNames[currentDate.getMonth()] + " " + currentDate.getFullYear();

        const tbody = document.getElementById('calendar-body');
        tbody.innerHTML = '';

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const firstDay = new Date(year, month, 1).getDay(); // 0 = dimanche
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let row = document.createElement('tr');
        let dayCount = 1;

        // Décalage pour le premier jour
        for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
            const cell = document.createElement('td');
            cell.classList.add('other-month');
            cell.textContent = '';
            row.appendChild(cell);
        }

        for (let i = (firstDay === 0 ? 6 : firstDay - 1); i < 7; i++) {
            addDayCell(row, dayCount, year, month);
            dayCount++;
        }
        tbody.appendChild(row);

        while (dayCount <= daysInMonth) {
            row = document.createElement('tr');
            for (let i = 0; i < 7; i++) {
                if (dayCount > daysInMonth) break;
                addDayCell(row, dayCount, year, month);
                dayCount++;
            }
            tbody.appendChild(row);
        }
    }

    // Ajouter une cellule de jour
    function addDayCell(row, day, year, month) {
        const cell = document.createElement('td');
        cell.textContent = day;

        const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        events.filter(e => e.date === dayStr).forEach(e => {
            const div = document.createElement('div');
            div.textContent = `${e.title} (${e.time})`;
            div.className = 'event ' + (e.statut === 'confirmé' ? 'confirmé' : 'en-attente');

            // clic pour redirection vers la page du RDV
            if (e.url) {
                div.onclick = () => { window.location.href = e.url; };
            }

            cell.appendChild(div);
        });

        row.appendChild(cell);
    }

    // Navigation mois
    function prevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        buildCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        buildCalendar();
    }

    buildCalendar();
</script>
{% endblock %}